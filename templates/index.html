<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>恶意软件检测系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.4/font/bootstrap-icons.css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>


        p {
            text-align: center;
            margin: auto;
        }

        .bi {
            vertical-align: -.125em;
            fill: currentColor;
        }

        .nav-scroller .nav {
            display: flex;
            flex-wrap: nowrap;
            padding-bottom: 1rem;
            margin-top: -1px;
            overflow-x: auto;
            text-align: center;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .text-small {
            font-size: 85%;
        }

        .dropdown-toggle {
            outline: 0;
        }


        .js-upload-finished {
            margin-top: 20px;
        }

        .list-group {
            margin-top: 10px;
        }

        /* layout.css Style */
        .upload-drop-zone {
            height: 200px;
            border-width: 2px;
            margin-bottom: 20px;
        }

        /* skin.css Style*/
        .upload-drop-zone {
            color: #ccc;
            border-style: dashed;
            border-color: #ccc;
            line-height: 200px;
            text-align: center
        }

        .upload-drop-zone.drop {
            color: #222;
            border-color: #222;
        }


    </style>
</head>
<body>
<main>
    <header class="p-3 mb-3 border-bottom">
        <div class="container">
            <div class="d-flex   justify-content-between  ">
                <div class="col-md-3 mb-2 mb-md-0">

                    <a href="/index"
                       class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
                        <img src="{{ url_for('static', filename = 'malware.png') }}" class="bi me-2" width="50"
                             height="50" role="img" \><span class="fs-4">恶意软件检测系统</span>
                    </a>
                </div>
                <div class="d-flex">
                    <ul class="nav justify-content-end">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/index">首页</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="fileImport1">上传文件</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/show_files">检测结果</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/comments">社区评论</a>
                        </li>
                    </ul>
                    <div>
                        {% if 'username' in session %}
                            <p>欢迎，{{ session['username'] }}！</p>
                            <a href="/logout">退出登录</a>
                        {% else %}
                            <a href="/login" class="btn btn-primary" type="button">登录</a>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
    </header>

    <div class="container my-4">
        <div class="p-5 text-center bg-body-tertiary rounded-3">
            <h1 class="text-body-emphasis">恶意软件检测</h1>
            <p class="col-lg-6 mx-auto fs-5 text-muted mb-4">
                点击或拖拽文件上传。<strong>(支持windows常见文件类型分析)</strong>
            </p>
        </div>
    </div>
    <div class="modal" id="identifier">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card">

                <!-- 模态框头部 -->
                <div class="modal-header card-header">
                    {#                    <img src="https://s.threatbook.com/api/file?icon=EXE-86&color=%238A8D99" >#}
                    <h4 class="modal-title" id="pe_name"></h4>

                </div>

                <!-- 模态框内容 -->
                <div class="modal-body card-body">
                    <button id="analyse" class="btn btn-danger" data-bs-dismiss="modal">开始检测</button>
                </div>

                <!-- 模态框底部 -->
                <div class="modal-footer card-footer">

                </div>

            </div>
        </div>
    </div>

    <div class="modal" id="identifier_result">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card">

                <!-- 模态框头部 -->
                <div class="modal-header card-header">
                    {#                    <img src="https://s.threatbook.com/api/file?icon=EXE-86&color=%238A8D99" >#}
                    <h4 class="modal-title" id="pe_name1"></h4>

                </div>

                <!-- 模态框内容 -->
                <div class="modal-body card-body">
                    <p><span id="detect_result"></span>file</p>
                </div>

                <!-- 模态框底部 -->
                <div class="modal-footer card-footer">
                    <button id="close_result" class="btn btn-danger" data-bs-dismiss="modal">关闭</button>
                </div>

            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-body">
                <!-- Standar Form -->
                <div class="row mb-3">
                    <div class="col-sm-6 mb-3 mb-sm-0">
                        <div class="input-group">
                            <span class="input-group-text">上传文件</span>
                            <input id="fileupload" type="file" name="fileupload" accept=".exe,.dll"
                                   multiple=""
                                   style="display:none;"/>
                            <input type='text' class="form-control" name='textfield' id='textfield'
                                   autocomplete="off"
                                   disabled/>
                            <input id="fileImport" type="button" value="上传文件" class="btn btn-primary"/>
                        </div>
                    </div>
                </div>
                <!-- Drop Zone -->
                <div class="upload-drop-zone" id="drop-zone">
                    <p>在此拖拽上传(.exe, .dll, .ocx)
                    <p/>
                </div>
                <!-- Upload Finished -->
                <!--                <div class="js-upload-finished"></div>-->
                <div id="liveAlertPlaceholder"></div>
            </div>
        </div>
    </div>

</main>


<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        $.ajax({
            url: '/getSession',
            type: 'POST',
            data: {},
            success: function (data) {
                $("#username").text(data['username']);
            }

        });

        $("#analyse").click(function () {
            submitFile()
        });

        $("#fileImport").click(function () {
            $('#fileupload').click();
        });
        $("#fileImport1").click(function () {
            $('#fileupload').click();
        });
        $('#fileupload').change(function () {
            uploadFile()
        })
    });

    const alertPlaceholder = document.getElementById('liveAlertPlaceholder')

    const alert = (message, type) => {
        const wrapper = document.createElement('div')
        wrapper.innerHTML = [
            `<div class="alert alert-${type} alert-dismissible fade show" role="alert">`,
            `   <div>${message}</div>`,
            '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
            '</div>'
        ].join('')

        alertPlaceholder.append(wrapper)
    }

    $(function () {
        // UPLOAD CLASS DEFINITION
        // ======================

        var dropZone = document.getElementById('drop-zone');
        var uploadForm = $('#js-upload-form');

        uploadForm.on('submit', function (e) {
            var uploadFiles = $('#fileupload').prop('files');
            e.preventDefault()
            startUpload(uploadFiles)
        })

        dropZone.ondrop = function (e) {
            e.preventDefault();
            this.className = 'upload-drop-zone';
            $("#textfield").val('');//清空手动浏览上传文件的input
            startUpload(e.dataTransfer.files)
        }
        dropZone.ondragover = function () {
            this.className = 'upload-drop-zone drop';
            return false;
        }
        dropZone.ondragleave = function () {
            this.className = 'upload-drop-zone';
            return false;
        }
    })

    function isAssetTypeIllagle(ext) {
        return [
            '.exe', '.dll', '.ocx'].indexOf(ext.toLowerCase()) !== -1;
    }

    var global_file;
    var detect_result;

    function uploadFile() {
        {% if 'username' not in session %}
            alert("Please login first.", "danger");
        {% else %}
            var uploadFiles = $('#fileupload').prop('files');
            $("#textfield").val(uploadFiles[0].name);
            startUpload(uploadFiles)
        {% endif %}
    }


    function startUpload(file) {
        // 上传的文件
        console.log(file)
        global_file = file[0].name
        document.getElementById('pe_name').textContent = global_file;
        document.getElementById('pe_name1').textContent = global_file;
        // $('.js-upload-finished').html(
        //     '<h3>已上传文件</h3>' +
        //     '<div class="list-group">' +
        //     '<a href="#" class="list-group-item list-group-item-success">' +
        //     '<span class="badge alert-success pull-right">Success</span>' +
        //     files[0].name + '</a></div>'
        // )
        var index = file[0].name.lastIndexOf(".");
        var ext = file[0].name.substring(index);
        var formData = new FormData();
        formData.append("contentid", "1")
        formData.append("contenttype", "1")
        formData.append("file", file[0])
        $.ajax({
            url: "/uploadfile",
            data: formData,
            type: 'POST',
            datatype: "json",
            contentType: false,//必须false才会自动加上正确的Content-Type
            processData: false,//必须false才会避开jQuery对 formdata 的默认处理，XMLHttpRequest会对 formdata 进行正确的处理
            success: function (jdata) {
                if (jdata['status'] === 'success') {
                    alert(file[0].name + "上传成功！", "success");
                } else {
                    alert(file[0].name + "上传失败！", "danger");
                }
            }
        });
        $('#identifier').modal('show')

    }

    function submitFile() {
        console.log(global_file)
        var data = {
            data: JSON.stringify({
                'file_name': global_file,
            }),
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            url: "/detect",
            data: data,
            success: function (result) {
                if (result['status'] === "failed") {
                    alert("任务创建失败", "danger");
                } else {
                    console.log(result);
                    detect_result = JSON.stringify(result.output)
                    console.log(detect_result)
                    document.getElementById('detect_result').textContent = detect_result;
                    $('#identifier_result').modal('show')
                }
            }
        });


    }


</script>
</body>
</html>